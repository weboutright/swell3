<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/favicon.png"/>
    <title>Swell Booking Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .brand-font {
            font-family: 'Luckiest Guy', cursive;
        }
        
        /* Widget container */
        .widget-container {
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(4, 120, 87, 0.15);
            overflow: hidden;
        }
        
        /* Premium gradient backgrounds */
        .premium-gradient {
            background: linear-gradient(135deg, #065f46 0%, #047857 50%, #059669 100%);
        }
        
        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }
        
        .btn-secondary {
            background: white;
            border: 2px solid #d1fae5;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            border-color: #059669;
            background: #ecfdf5;
        }
        
        /* Input styles */
        .widget-input {
            border: 2px solid #d1fae5;
            transition: all 0.3s ease;
            background: white;
        }
        
        .widget-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }
        
        /* Service cards */
        .service-card {
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.9) 0%, rgba(240, 253, 244, 0.7) 100%);
            border: 2px solid rgba(16, 185, 129, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .service-card:hover {
            border-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.15);
        }
        
        .service-card.selected {
            border-color: #047857;
            background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.25);
        }
        
        /* Calendar styles */
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .calendar-day:hover:not(.disabled):not(.unavailable) {
            background: #ecfdf5;
            transform: scale(1.05);
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            font-weight: 700;
        }
        
        .calendar-day.disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }
        
        .calendar-day.unavailable {
            background: #fee2e2;
            color: #991b1b;
            cursor: not-allowed;
        }
        
        .calendar-day.holiday {
            background: #ddd6fe;
            color: #6b21a8;
        }
        
        /* Time slot styles */
        .time-slot {
            padding: 12px 20px;
            border: 2px solid #d1fae5;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            text-align: center;
        }
        
        .time-slot:hover:not(.unavailable) {
            border-color: #059669;
            background: #ecfdf5;
            transform: scale(1.02);
        }
        
        .time-slot.selected {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border-color: #047857;
        }
        
        .time-slot.unavailable {
            background: #fef2f2;
            color: #991b1b;
            border-color: #fecaca;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Progress indicator */
        .progress-step {
            position: relative;
            flex: 1;
        }
        
        .progress-step::before {
            content: '';
            position: absolute;
            top: 16px;
            left: 50%;
            right: -50%;
            height: 3px;
            background: #d1fae5;
            z-index: 0;
        }
        
        .progress-step:last-child::before {
            display: none;
        }
        
        .progress-step.active .step-circle {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border-color: #047857;
        }
        
        .progress-step.completed .step-circle {
            background: #d1fae5;
            border-color: #059669;
        }
        
        .progress-step.completed::before {
            background: #059669;
        }
        
        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            border: 3px solid #d1fae5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        /* Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.4s ease-out;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #d1fae5;
            border-top: 3px solid #059669;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Success checkmark */
        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Widget Container -->
    <div class="widget-container max-w-4xl mx-auto">
        <!-- Header -->
        <div class="premium-gradient p-6 md:p-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mr-3">
                        <i data-lucide="waves" class="w-7 h-7 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-black brand-font text-white">Swell</h1>
                        <p class="text-emerald-100 text-sm">Book Your Session</p>
                    </div>
                </div>
                <button onclick="closeWidget()" class="text-white hover:bg-white/10 p-2 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="px-6 md:px-8 py-6 bg-white border-b border-gray-100">
            <div class="flex items-center justify-between max-w-2xl mx-auto">
                <div class="progress-step active" id="step-1">
                    <div class="step-circle">1</div>
                    <p class="text-xs mt-2 font-semibold text-gray-600 text-center">Service</p>
                </div>
                <div class="progress-step" id="step-2">
                    <div class="step-circle">2</div>
                    <p class="text-xs mt-2 font-semibold text-gray-400 text-center">Date & Time</p>
                </div>
                <div class="progress-step" id="step-3">
                    <div class="step-circle">3</div>
                    <p class="text-xs mt-2 font-semibold text-gray-400 text-center">Details</p>
                </div>
                <div class="progress-step" id="step-4">
                    <div class="step-circle">4</div>
                    <p class="text-xs mt-2 font-semibold text-gray-400 text-center">Confirm</p>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="p-6 md:p-8">
            
            <!-- Step 1: Select Service -->
            <div id="step-service" class="step-content slide-in">
                <h2 class="text-2xl font-black text-gray-800 mb-2">Select a Service</h2>
                <p class="text-gray-600 mb-6">Choose the type of session you'd like to book</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="services-container">
                    <!-- Services will be populated here -->
                </div>
                
                <div class="flex justify-end mt-8">
                    <button onclick="nextStep()" id="service-next-btn" disabled class="btn-primary text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        Continue
                        <i data-lucide="arrow-right" class="w-5 h-5 inline ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Select Date & Time -->
            <div id="step-datetime" class="step-content hidden">
                <h2 class="text-2xl font-black text-gray-800 mb-2">Select Date & Time</h2>
                <p class="text-gray-600 mb-6">Choose your preferred date and available time slot</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Calendar -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Select Date</h3>
                            <div class="flex space-x-2">
                                <button onclick="previousMonth()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    <i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
                                </button>
                                <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border-2 border-gray-100 p-4">
                            <h4 class="text-center font-bold text-gray-800 mb-4" id="calendar-month">January 2025</h4>
                            <div class="grid grid-cols-7 gap-2 mb-2">
                                <div class="text-center text-xs font-bold text-gray-500">Sun</div>
                                <div class="text-center text-xs font-bold text-gray-500">Mon</div>
                                <div class="text-center text-xs font-bold text-gray-500">Tue</div>
                                <div class="text-center text-xs font-bold text-gray-500">Wed</div>
                                <div class="text-center text-xs font-bold text-gray-500">Thu</div>
                                <div class="text-center text-xs font-bold text-gray-500">Fri</div>
                                <div class="text-center text-xs font-bold text-gray-500">Sat</div>
                            </div>
                            <div class="grid grid-cols-7 gap-2" id="calendar-days">
                                <!-- Calendar days will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Slots -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Available Times</h3>
                        
                        <!-- Timezone Info -->
                        <div id="timezone-info"></div>
                        
                        <div id="time-slots-container" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center py-12 text-gray-500">
                                <i data-lucide="calendar-clock" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                                <p>Select a date to view available times</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-8">
                    <button onclick="previousStep()" class="btn-secondary text-gray-700 px-8 py-3 rounded-xl font-bold">
                        <i data-lucide="arrow-left" class="w-5 h-5 inline mr-2"></i>
                        Back
                    </button>
                    <button onclick="nextStep()" id="datetime-next-btn" disabled class="btn-primary text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        Continue
                        <i data-lucide="arrow-right" class="w-5 h-5 inline ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Enter Details -->
            <div id="step-details" class="step-content hidden">
                <h2 class="text-2xl font-black text-gray-800 mb-2">Your Details</h2>
                <p class="text-gray-600 mb-6">Please provide your contact information</p>
                
                <div class="space-y-4 max-w-2xl">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-800 mb-2">First Name *</label>
                            <input type="text" id="firstName" class="widget-input w-full p-3 rounded-xl" placeholder="John" required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-800 mb-2">Last Name *</label>
                            <input type="text" id="lastName" class="widget-input w-full p-3 rounded-xl" placeholder="Doe" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Email Address *</label>
                        <input type="email" id="email" class="widget-input w-full p-3 rounded-xl" placeholder="john.doe@example.com" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Phone Number *</label>
                        <input type="tel" id="phone" class="widget-input w-full p-3 rounded-xl" placeholder="(555) 123-4567" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">Additional Notes (Optional)</label>
                        <textarea id="notes" class="widget-input w-full p-3 rounded-xl" rows="4" placeholder="Any special requests or information we should know..."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-between mt-8">
                    <button onclick="previousStep()" class="btn-secondary text-gray-700 px-8 py-3 rounded-xl font-bold">
                        <i data-lucide="arrow-left" class="w-5 h-5 inline mr-2"></i>
                        Back
                    </button>
                    <button onclick="nextStep()" id="details-next-btn" class="btn-primary text-white px-8 py-3 rounded-xl font-bold">
                        Continue
                        <i data-lucide="arrow-right" class="w-5 h-5 inline ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Confirm & Pay -->
            <div id="step-confirm" class="step-content hidden">
                <h2 class="text-2xl font-black text-gray-800 mb-2">Confirm Your Booking</h2>
                <p class="text-gray-600 mb-6" id="confirm-subtitle">Review your booking details before confirming</p>
                
                <div class="max-w-2xl space-y-4">
                    <!-- Booking Summary Card -->
                    <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-2xl p-6 border-2 border-emerald-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="calendar-check" class="w-5 h-5 mr-2 text-emerald-600"></i>
                            Booking Summary
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Service:</span>
                                <span class="text-gray-800 font-bold" id="confirm-service">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Duration:</span>
                                <span class="text-gray-800 font-bold" id="confirm-duration">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Date:</span>
                                <span class="text-gray-800 font-bold" id="confirm-date">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Time:</span>
                                <span class="text-gray-800 font-bold" id="confirm-time">-</span>
                            </div>
                            <div class="border-t-2 border-emerald-200 pt-3 mt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-800 font-bold text-lg">Total Price:</span>
                                    <span class="text-emerald-600 font-black text-2xl" id="confirm-price">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Details Card -->
                    <div class="bg-white rounded-2xl p-6 border-2 border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="user" class="w-5 h-5 mr-2 text-gray-600"></i>
                            Contact Information
                        </h3>
                        <div class="space-y-2 text-gray-600">
                            <p><span class="font-semibold">Name:</span> <span id="confirm-name">-</span></p>
                            <p><span class="font-semibold">Email:</span> <span id="confirm-email">-</span></p>
                            <p><span class="font-semibold">Phone:</span> <span id="confirm-phone">-</span></p>
                            <p id="confirm-notes-container" class="hidden"><span class="font-semibold">Notes:</span> <span id="confirm-notes">-</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-8">
                    <button onclick="previousStep()" class="btn-secondary text-gray-700 px-8 py-3 rounded-xl font-bold">
                        <i data-lucide="arrow-left" class="w-5 h-5 inline mr-2"></i>
                        Back
                    </button>
                    <button onclick="processBooking()" id="confirm-btn" class="btn-primary text-white px-8 py-3 rounded-xl font-bold">
                        <i data-lucide="check-circle" class="w-5 h-5 inline mr-2"></i>
                        <span id="confirm-btn-text">Confirm Booking</span>
                    </button>
                </div>
            </div>

            <!-- Step 5: Success -->
            <div id="step-success" class="step-content hidden text-center">
                <div class="success-checkmark">
                    <i data-lucide="check" class="w-12 h-12 text-emerald-600"></i>
                </div>
                <h2 class="text-3xl font-black text-gray-800 mb-2">Booking Confirmed!</h2>
                <p class="text-gray-600 mb-6 text-lg">Your session has been successfully booked</p>
                
                <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-2xl p-8 max-w-2xl mx-auto border-2 border-emerald-200 mb-8">
                    <div class="space-y-4 text-left">
                        <div class="flex items-start">
                            <i data-lucide="calendar" class="w-6 h-6 text-emerald-600 mr-3 mt-1"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">Session Details</p>
                                <p class="text-lg font-bold text-gray-800" id="success-details">-</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i data-lucide="mail" class="w-6 h-6 text-emerald-600 mr-3 mt-1"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">Confirmation Sent To</p>
                                <p class="text-lg font-bold text-gray-800" id="success-email">-</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i data-lucide="info" class="w-6 h-6 text-emerald-600 mr-3 mt-1"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">What's Next?</p>
                                <p class="text-gray-700">Check your email for the calendar invite and meeting details. You'll receive a reminder 24 hours before your session.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="resetWidget()" class="btn-primary text-white px-8 py-3 rounded-xl font-bold">
                    <i data-lucide="home" class="w-5 h-5 inline mr-2"></i>
                    Book Another Session
                </button>
            </div>

        </div>
    </div>

    <script>
        // Configuration - UPDATE THIS WITH YOUR GOOGLE APPS SCRIPT URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz61JIlj9F-84byXh6OjxkM62prukzqJWSKyqhzw8DHliQRijPXmUzlgy14c9CPHfzzAA/exec';
        
        // Detect user's timezone
        const USER_TIMEZONE = Intl.DateTimeFormat().resolvedOptions().timeZone;
        let BUSINESS_TIMEZONE = 'Australia/Brisbane'; // Will be updated from API
        
        // Timezone utility functions
        function getUserTimezone() {
            return Intl.DateTimeFormat().resolvedOptions().timeZone;
        }
        
        function convertToUserTimezone(isoString, userTimezone) {
            const date = new Date(isoString);
            const options = {
                timeZone: userTimezone,
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }
        
        function getTimezoneAbbreviation(timezone) {
            const date = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                timeZoneName: 'short'
            });
            const parts = formatter.formatToParts(date);
            const timeZonePart = parts.find(part => part.type === 'timeZoneName');
            return timeZonePart ? timeZonePart.value : timezone;
        }
        
        function showTimezoneInfo() {
            const userAbbr = getTimezoneAbbreviation(USER_TIMEZONE);
            const businessAbbr = getTimezoneAbbreviation(BUSINESS_TIMEZONE);
            
            if (USER_TIMEZONE !== BUSINESS_TIMEZONE) {
                const timezoneInfo = document.getElementById('timezone-info');
                if (timezoneInfo) {
                    timezoneInfo.innerHTML = `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
                            <div class="flex items-start">
                                <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2 flex-shrink-0 mt-0.5"></i>
                                <div class="text-sm text-blue-800">
                                    <p class="font-semibold">Timezone Notice</p>
                                    <p>Times shown in your local timezone (${userAbbr})</p>
                                    <p class="text-xs mt-1">Business operates in ${businessAbbr}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
        }
        
        // Widget configuration - will be loaded from API
        let widgetConfig = {
            services: [],
            businessHours: {},
            holidays: [],
            paymentsEnabled: true
        };

        // Widget State
        let currentStep = 1;
        let selectedService = null;
        let selectedDate = null;
        let selectedTime = null;
        let currentMonth = new Date();
        let bookingData = {};

        // Initialize widget
        document.addEventListener('DOMContentLoaded', () => {
            initializeWidget();
            lucide.createIcons();
        });

        async function initializeWidget() {
            // Load services and config from API
            await loadServicesFromAPI();
            
            // Show timezone info if different
            showTimezoneInfo();
            
            // Initialize calendar (will render with default/loaded business hours)
            renderCalendar();
        }
        
        async function loadServicesFromAPI() {
            try {
                // Load services
                const servicesResponse = await fetch(GOOGLE_SCRIPT_URL + '?action=getServices');
                const servicesData = await servicesResponse.json();
                
                if (servicesData.success && servicesData.services) {
                    widgetConfig.services = servicesData.services.filter(s => s.enabled !== false);
                    renderServices();
                } else {
                    showError('Unable to load services. Please try again later.');
                    return;
                }
                
                // Note: Business hours and holidays would need to be fetched separately
                // For now, the availability check happens when user selects a date
                // The backend will handle business hours validation in getAvailability
                
            } catch (error) {
                console.error('Error loading services:', error);
                showError('Connection error. Please check your internet connection.');
            }
        }
        
        function showError(message) {
            const container = document.getElementById('services-container');
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="alert-circle" class="w-8 h-8 text-red-600"></i>
                    </div>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
            lucide.createIcons();
        }

        function renderServices() {
            const container = document.getElementById('services-container');
            
            if (!widgetConfig.services || widgetConfig.services.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="calendar-x" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <p class="text-gray-600">No services available at this time.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = widgetConfig.services.map(service => `
                <div class="service-card p-6 rounded-2xl" onclick="selectService('${service.id || service.name}')">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-bold text-gray-800">${service.name}</h3>
                        <span class="text-emerald-600 font-black text-xl">$${service.price || 0}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">${service.description || 'Professional service'}</p>
                    <div class="flex items-center text-sm text-gray-500">
                        <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                        <span>${service.duration || 60} minutes</span>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function selectService(serviceId) {
            // Remove previous selection
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection
            event.currentTarget.classList.add('selected');
            selectedService = widgetConfig.services.find(s => (s.id || s.name) === serviceId);
            
            // Enable next button
            document.getElementById('service-next-btn').disabled = false;
        }

        function renderCalendar() {
            const monthElement = document.getElementById('calendar-month');
            const daysElement = document.getElementById('calendar-days');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            // Set month/year header
            monthElement.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Build calendar
            let html = '';
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            // Days of month
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                
                let classes = 'calendar-day';
                let onclick = '';
                
                // Check if past date
                if (date < today) {
                    classes += ' disabled';
                } else {
                    // Future dates are clickable - API will determine availability
                    onclick = `onclick="selectDate('${dateString}')"`;
                }
                
                html += `<div class="${classes}" ${onclick}>${day}</div>`;
            }
            
            daysElement.innerHTML = html;
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        function selectDate(dateString) {
            // Remove previous selection
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Add selection
            event.currentTarget.classList.add('selected');
            selectedDate = dateString;
            
            // Generate time slots
            renderTimeSlots(dateString);
        }

        async function renderTimeSlots(dateString) {
            const container = document.getElementById('time-slots-container');
            container.innerHTML = '<div class="text-center py-12 text-gray-500">Loading available times...</div>';
            
            if (!selectedService) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">Please select a service first</div>';
                return;
            }
            
            try {
                // Fetch availability from API
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'getAvailability',
                        date: dateString,
                        serviceId: selectedService.id || selectedService.name
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    container.innerHTML = `<div class="text-center py-12 text-red-500">Error: ${data.error}</div>`;
                    return;
                }
                
                // Update business timezone from response
                if (data.businessTimezone) {
                    BUSINESS_TIMEZONE = data.businessTimezone;
                    showTimezoneInfo();
                }
                
                const slots = data.availableSlots || [];
                
                if (slots.length === 0) {
                    container.innerHTML = '<div class="text-center py-12 text-gray-500">No available times for this date</div>';
                    return;
                }
                
                // Render time slots with timezone conversion
                let html = '<div class="grid grid-cols-3 gap-2">';
                
                slots.forEach(slot => {
                    // Convert ISO time to user's timezone
                    const userTime = convertToUserTimezone(slot.start, USER_TIMEZONE);
                    const slotStartISO = slot.start;
                    
                    html += `
                        <div class="time-slot cursor-pointer" 
                             onclick="selectTime('${slotStartISO}')"
                             data-slot-start="${slotStartISO}"
                             data-slot-end="${slot.end}">
                            ${userTime}
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error fetching availability:', error);
                container.innerHTML = '<div class="text-center py-12 text-red-500">Error loading available times. Please try again.</div>';
            }
        }

        function formatTime(timeString) {
            const [hour, min] = timeString.split(':').map(Number);
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${min.toString().padStart(2, '0')} ${period}`;
        }

        function selectTime(slotStartISO) {
            // Remove previous selection
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Add selection
            event.currentTarget.classList.add('selected');
            selectedTime = slotStartISO; // Store ISO format for backend
            
            // Enable next button
            document.getElementById('datetime-next-btn').disabled = false;
        }

        function nextStep() {
            // Validate current step
            if (currentStep === 1 && !selectedService) {
                alert('Please select a service');
                return;
            }
            
            if (currentStep === 2 && (!selectedDate || !selectedTime)) {
                alert('Please select a date and time');
                return;
            }
            
            if (currentStep === 3) {
                // Validate form
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                
                if (!firstName || !lastName || !email || !phone) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                if (!isValidEmail(email)) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                // Store booking data
                bookingData = {
                    service: selectedService,
                    date: selectedDate,
                    time: selectedTime,
                    firstName,
                    lastName,
                    email,
                    phone,
                    notes: document.getElementById('notes').value.trim()
                };
                
                // Update confirmation display
                updateConfirmation();
            }
            
            // Move to next step
            currentStep++;
            showStep(currentStep);
        }

        function previousStep() {
            currentStep--;
            showStep(currentStep);
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show current step
            const stepMap = {
                1: 'step-service',
                2: 'step-datetime',
                3: 'step-details',
                4: 'step-confirm',
                5: 'step-success'
            };
            
            document.getElementById(stepMap[step]).classList.remove('hidden');
            
            // Update progress indicator
            updateProgress(step);
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Re-create icons
            lucide.createIcons();
        }

        function updateProgress(step) {
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                stepElement.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepElement.classList.add('completed');
                    stepElement.querySelector('p').classList.remove('text-gray-400');
                    stepElement.querySelector('p').classList.add('text-gray-600');
                } else if (i === step) {
                    stepElement.classList.add('active');
                    stepElement.querySelector('p').classList.remove('text-gray-400');
                    stepElement.querySelector('p').classList.add('text-gray-600');
                } else {
                    stepElement.querySelector('p').classList.add('text-gray-400');
                    stepElement.querySelector('p').classList.remove('text-gray-600');
                }
            }
        }

        function updateConfirmation() {
            document.getElementById('confirm-service').textContent = bookingData.service.name;
            document.getElementById('confirm-duration').textContent = `${bookingData.service.duration} minutes`;
            
            // Display date in user's timezone
            const appointmentDate = new Date(bookingData.time);
            document.getElementById('confirm-date').textContent = appointmentDate.toLocaleDateString('en-US', { 
                timeZone: USER_TIMEZONE,
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Display time in user's timezone with timezone indicator
            const userTime = convertToUserTimezone(bookingData.time, USER_TIMEZONE);
            const userAbbr = getTimezoneAbbreviation(USER_TIMEZONE);
            document.getElementById('confirm-time').textContent = `${userTime} ${userAbbr}`;
            
            document.getElementById('confirm-price').textContent = `$${bookingData.service.price}`;
            
            document.getElementById('confirm-name').textContent = `${bookingData.firstName} ${bookingData.lastName}`;
            document.getElementById('confirm-email').textContent = bookingData.email;
            document.getElementById('confirm-phone').textContent = bookingData.phone;
            
            if (bookingData.notes) {
                document.getElementById('confirm-notes').textContent = bookingData.notes;
                document.getElementById('confirm-notes-container').classList.remove('hidden');
            } else {
                document.getElementById('confirm-notes-container').classList.add('hidden');
            }
            
            // Update button text based on payment settings
            const confirmBtn = document.getElementById('confirm-btn');
            const confirmBtnText = document.getElementById('confirm-btn-text');
            const confirmSubtitle = document.getElementById('confirm-subtitle');
            
            if (widgetConfig.paymentsEnabled && bookingData.service.price > 0) {
                confirmBtnText.textContent = 'Proceed to Payment';
                confirmSubtitle.textContent = 'Review your booking details before proceeding to payment';
                confirmBtn.querySelector('i').setAttribute('data-lucide', 'credit-card');
            } else {
                confirmBtnText.textContent = 'Confirm Booking';
                confirmSubtitle.textContent = 'Review your booking details before confirming';
                confirmBtn.querySelector('i').setAttribute('data-lucide', 'check-circle');
            }
            
            // Re-create icons to update the changed icon
            lucide.createIcons();
        }

        async function processBooking() {
            const btn = document.getElementById('confirm-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner inline-block"></div> Processing...';
            
            try {
                // Create booking via API
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'createBooking',
                        booking: {
                            serviceId: selectedService.id || selectedService.name,
                            service: selectedService.name,
                            date: selectedDate,
                            time: new Date(selectedTime).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                            firstName: bookingData.firstName,
                            lastName: bookingData.lastName,
                            email: bookingData.email,
                            phone: bookingData.phone,
                            notes: bookingData.notes || ''
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessScreen();
                } else {
                    throw new Error(data.error || 'Booking failed');
                }
                
            } catch (error) {
                console.error('Booking error:', error);
                alert('Booking failed: ' + error.message + '\nPlease try again or contact support.');
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 inline mr-2"></i> Confirm Booking';
                lucide.createIcons();
            }
        }

        function showSuccessScreen() {
            const details = `${bookingData.service.name} on ${new Date(bookingData.date + 'T00:00:00').toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            })} at ${formatTime(bookingData.time)}`;
            
            document.getElementById('success-details').textContent = details;
            document.getElementById('success-email').textContent = bookingData.email;
            
            currentStep = 5;
            showStep(5);
        }

        function resetWidget() {
            // Reset all state
            currentStep = 1;
            selectedService = null;
            selectedDate = null;
            selectedTime = null;
            bookingData = {};
            
            // Reset form
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('notes').value = '';
            
            // Disable next buttons
            document.getElementById('service-next-btn').disabled = true;
            document.getElementById('datetime-next-btn').disabled = true;
            
            // Show first step
            showStep(1);
        }

        function closeWidget() {
            // In iframe mode, send message to parent
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'closeWidget' }, '*');
            } else {
                // Standalone mode, just reset
                if (confirm('Are you sure you want to close? Your progress will be lost.')) {
                    resetWidget();
                }
            }
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Listen for configuration updates from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'updateConfig') {
                Object.assign(widgetConfig, event.data.config);
                initializeWidget();
            }
        });
    </script>

</body>
</html>
